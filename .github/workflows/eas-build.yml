name: EAS Build and Deploy

on:
  push:
    branches: [ main ]
    paths: [ 'ReadMaker/**' ]
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build for'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ios
        - android
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
        - development
        - preview
        - production

jobs:
  build:
    name: EAS Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ReadMaker/package-lock.json

    - name: Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: Install dependencies
      run: cd ReadMaker && npm ci

    - name: Create app.config.js with production API URL
      if: github.event.inputs.profile == 'production' || (github.event.inputs.profile == '' && github.ref == 'refs/heads/main')
      run: |
        cd ReadMaker
        cat > app.config.js << EOF
        export default {
          expo: {
            name: "ReadMaker",
            slug: "readmaker",
            version: "1.0.0",
            orientation: "portrait",
            icon: "./assets/icon.png",
            userInterfaceStyle: "light",
            splash: {
              image: "./assets/splash.png",
              resizeMode: "contain",
              backgroundColor: "#ffffff"
            },
            assetBundlePatterns: [
              "**/*"
            ],
            ios: {
              supportsTablet: true,
              bundleIdentifier: "com.readmaker.app"
            },
            android: {
              adaptiveIcon: {
                foregroundImage: "./assets/adaptive-icon.png",
                backgroundColor: "#FFFFFF"
              },
              package: "com.readmaker.app"
            },
            web: {
              favicon: "./assets/favicon.png"
            },
            extra: {
              apiBaseUrl: "${{ secrets.RAILWAY_DOMAIN }}",
              eas: {
                projectId: "${{ secrets.EXPO_PROJECT_ID }}"
              }
            },
            updates: {
              url: "https://u.expo.dev/${{ secrets.EXPO_PROJECT_ID }}"
            },
            runtimeVersion: {
              policy: "sdkVersion"
            }
          }
        };
        EOF

    - name: Build app for development
      if: github.event.inputs.profile == 'development'
      run: cd ReadMaker && eas build --platform ${{ github.event.inputs.platform || 'all' }} --profile development --non-interactive

    - name: Build app for preview
      if: github.event.inputs.profile == 'preview' || (github.event.inputs.profile == '' && github.ref != 'refs/heads/main')
      run: cd ReadMaker && eas build --platform ${{ github.event.inputs.platform || 'all' }} --profile preview --non-interactive

    - name: Build app for production
      if: github.event.inputs.profile == 'production' || (github.event.inputs.profile == '' && github.ref == 'refs/heads/main')
      run: cd ReadMaker && eas build --platform ${{ github.event.inputs.platform || 'all' }} --profile production --non-interactive

    - name: Create GitHub Release (Production only)
      if: github.ref == 'refs/heads/main' && (github.event.inputs.profile == 'production' || github.event.inputs.profile == '')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: ReadMaker v${{ github.run_number }}
        body: |
          ## ReadMaker Mobile App Release
          
          ### Features
          - 読書支援機能
          - ユーザー認証システム
          - Railway API連携
          
          ### Download
          - iOS: TestFlight
          - Android: Internal Testing
          
          ### API
          - Backend: ${{ secrets.RAILWAY_DOMAIN }}
        draft: false
        prerelease: false

    - name: Notify success
      if: success()
      run: |
        echo "🚀 EAS build completed successfully!"
        
        # Optional: Send Slack notification
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          PLATFORM="${{ github.event.inputs.platform || 'all' }}"
          PROFILE="${{ github.event.inputs.profile || 'preview' }}"
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"📱 ReadMaker app build completed successfully!\nPlatform: $PLATFORM\nProfile: $PROFILE\"}" \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

    - name: Notify failure
      if: failure()
      run: |
        echo "❌ EAS build failed!"
        
        # Optional: Send Slack notification
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"❌ ReadMaker app build failed!"}' \
            "${{ secrets.SLACK_WEBHOOK_URL }}"
        fi

  submit:
    name: Submit to App Stores
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && (github.event.inputs.profile == 'production' || github.event.inputs.profile == '')
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup Expo and EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: latest
        eas-version: latest
        token: ${{ secrets.EXPO_TOKEN }}

    - name: Submit to iOS App Store
      if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'all' || github.event.inputs.platform == ''
      run: cd ReadMaker && eas submit --platform ios --non-interactive
      continue-on-error: true

    - name: Submit to Google Play Store
      if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'all' || github.event.inputs.platform == ''
      run: cd ReadMaker && eas submit --platform android --non-interactive
      continue-on-error: true